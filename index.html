<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>言出我才 - AI职业发展伙伴</title>
    <!-- 引入 Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Marked 用于解析 Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- 引入 html2pdf 用于导出 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <!-- 引入 FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4F46E5; /* Indigo 600 */
            --secondary-color: #EC4899; /* Pink 500 */
            --bg-gradient: linear-gradient(135deg, #F3F4F6 0%, #E0E7FF 100%);
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-gradient);
            height: 100vh;
            overflow: hidden;
            color: #1F2937;
        }

        .serif { font-family: 'Noto Serif SC', serif; }

        /* 玻璃拟态效果 */
        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.1);
        }

        /* 聊天气泡动画 */
        .chat-enter-active, .chat-leave-active { transition: all 0.5s ease; }
        .chat-enter-from { opacity: 0; transform: translateY(20px); }

        /* 简历纸张质感 */
        .resume-paper {
            background: #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            min-height: 297mm; 
            position: relative;
        }
        
        /* Markdown 样式微调 */
        .markdown-body p { margin-bottom: 0.75em; }
        .markdown-body ul { list-style-type: disc; margin-left: 1.5em; margin-bottom: 0.75em; }
        .markdown-body strong { color: var(--primary-color); }

        /* 滚动条美化 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94A3B8; }

        .typing-dot {
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .fade-enter-active, .fade-leave-active { transition: opacity 0.5s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app" class="h-full flex flex-col">
    
    <!-- 顶部导航 -->
    <header class="h-16 glass-panel z-50 flex items-center justify-between px-8 shadow-sm">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-indigo-600 rounded-lg flex items-center justify-center text-white text-xl">
                <i class="fa-solid fa-fingerprint"></i>
            </div>
            <div>
                <h1 class="text-xl font-bold text-indigo-900 tracking-wide">言出我才</h1>
                <p class="text-xs text-indigo-500 font-medium">一席对话，尽显我才</p>
            </div>
        </div>
        <div class="flex items-center gap-4">
            <div v-if="apiKey || hasServerKey" class="text-xs text-green-600 flex items-center gap-1">
                <i class="fa-solid fa-circle text-[8px]"></i> 已连接 AI
            </div>
            <button @click="showApiModal = true" class="text-gray-500 hover:text-indigo-600 transition">
                <i class="fa-solid fa-gear"></i>
            </button>
        </div>
    </header>

    <!-- 主内容区域 -->
    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- 左侧：引导与状态 (侧边栏) -->
        <aside class="w-80 glass-panel m-4 mr-2 rounded-2xl flex flex-col border-r-0 hidden md:flex transition-all duration-500" 
               :class="{'w-0 opacity-0 p-0 m-0': stage === 'result'}">
            <div class="p-6 border-b border-gray-200/50">
                <h3 class="text-sm uppercase tracking-wider text-gray-500 font-bold mb-4">探索进度</h3>
                
                <!-- 任务清单 (To-Do List) -->
                <div class="space-y-3">
                    <div v-for="(task, index) in todoList" :key="index" 
                         class="flex items-center gap-3 p-3 rounded-lg transition-all duration-300"
                         :class="task.done ? 'bg-green-50 border border-green-100' : 'bg-white/50 border border-white'">
                        <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs transition-colors duration-300"
                             :class="task.done ? 'bg-green-500 text-white' : 'bg-gray-200 text-gray-400'">
                            <i class="fa-solid" :class="task.done ? 'fa-check' : 'fa-circle-notch'"></i>
                        </div>
                        <span class="text-sm font-medium" :class="task.done ? 'text-green-800' : 'text-gray-600'">{{ task.text }}</span>
                    </div>
                </div>
            </div>

            <div class="p-6 flex-1 overflow-y-auto">
                <h3 class="text-sm uppercase tracking-wider text-gray-500 font-bold mb-2">心理洞察</h3>
                <p class="text-xs text-gray-500 leading-relaxed mb-4">
                    我们将运用动机式访谈与STAR原则，不仅为了简历，更为了让你看清自己的价值。
                </p>
                <div v-if="insights.length > 0" class="space-y-2">
                    <div v-for="(tag, i) in insights" :key="i" class="inline-block px-2 py-1 bg-indigo-100 text-indigo-700 text-xs rounded-md mr-2 mb-2 animate-pulse">
                        # {{ tag }}
                    </div>
                </div>
            </div>
        </aside>

        <!-- 中间：核心交互区 -->
        <section class="flex-1 glass-panel m-4 ml-2 rounded-2xl flex flex-col relative shadow-xl overflow-hidden">
            
            <!-- Stage 0: 初始欢迎 & API 输入 (如果在 Modal 没输的话) -->
            <div v-if="!apiKey && !hasServerKey" class="absolute inset-0 z-50 bg-white/90 backdrop-blur flex items-center justify-center flex-col p-8 text-center">
                <div class="w-20 h-20 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 text-4xl mb-6 animate-bounce">
                    <i class="fa-solid fa-key"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800 mb-2">开启自我探索之旅</h2>
                <p class="text-gray-500 mb-8 max-w-md">请输入 Google Gemini API Key 或直接使用已配置的后端默认 Key。</p>
                <div class="flex gap-2 w-full max-w-md">
                    <input v-model="tempKey" type="password" placeholder="粘贴 API Key (AIzaSy...)" class="flex-1 px-4 py-3 rounded-xl border border-gray-300 focus:ring-2 focus:ring-indigo-500 outline-none">
                    <button @click="saveKey" class="bg-indigo-600 text-white px-6 py-3 rounded-xl hover:bg-indigo-700 font-medium transition shadow-lg hover:shadow-indigo-500/30">
                        启动
                    </button>
                </div>
                <p class="mt-4 text-xs text-gray-400">支持 gemini 模型族</p>
            </div>

            <!-- Stage 1 & 2: 对话界面 -->
            <div v-if="stage === 'chat' || stage === 'intro'" class="flex-1 flex flex-col h-full">
                <!-- 聊天记录 -->
                <div class="flex-1 overflow-y-auto p-6 space-y-6" id="chat-container">
                    <div v-for="(msg, idx) in chatHistory" :key="idx" class="flex w-full" :class="msg.role === 'user' ? 'justify-end' : 'justify-start'">
                        
                        <!-- AI 头像 -->
                        <div v-if="msg.role === 'model'" class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white text-xs shadow-lg mr-3 shrink-0 mt-1">
                            <i class="fa-solid fa-robot"></i>
                        </div>

                        <!-- 消息体 -->
                        <div class="max-w-[80%] p-4 rounded-2xl shadow-sm text-sm leading-relaxed"
                             :class="msg.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : 'bg-white text-gray-700 rounded-tl-none border border-gray-100'">
                            <div v-html="renderMarkdown(msg.text)"></div>
                        </div>

                        <!-- 用户头像 -->
                        <div v-if="msg.role === 'user'" class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 text-xs shadow-sm ml-3 shrink-0 mt-1">
                            <i class="fa-solid fa-user"></i>
                        </div>
                    </div>

                    <!-- Loading 状态 -->
                    <div v-if="isLoading" class="flex justify-start w-full">
                         <div class="w-8 h-8 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white text-xs shadow-lg mr-3 shrink-0 mt-1">
                            <i class="fa-solid fa-robot"></i>
                        </div>
                        <div class="bg-white p-4 rounded-2xl rounded-tl-none border border-gray-100 shadow-sm flex items-center gap-1">
                            <div class="w-2 h-2 bg-indigo-400 rounded-full typing-dot"></div>
                            <div class="w-2 h-2 bg-indigo-400 rounded-full typing-dot"></div>
                            <div class="w-2 h-2 bg-indigo-400 rounded-full typing-dot"></div>
                        </div>
                    </div>
                </div>

                <!-- 输入框 -->
                <div class="p-4 bg-white/50 backdrop-blur border-t border-gray-200/50">
                    <div class="relative flex items-center gap-2 bg-white p-2 rounded-xl border border-gray-200 shadow-inner focus-within:ring-2 focus-within:ring-indigo-100 transition">
                        <textarea v-model="userInput" @keydown.enter.prevent="sendMessage" 
                                  placeholder="输入你的想法，或者仅仅是你的困惑..." 
                                  class="flex-1 bg-transparent resize-none outline-none text-sm text-gray-700 max-h-32 py-2 px-2" rows="1"></textarea>
                        <button @click="sendMessage" :disabled="isLoading || !userInput.trim()" 
                                class="w-10 h-10 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition flex items-center justify-center shadow-md">
                            <i class="fa-solid fa-paper-plane"></i>
                        </button>
                    </div>
                    <div class="text-center mt-2">
                        <p class="text-[10px] text-gray-400">AI 将辅助你挖掘 STAR (情境/任务/行动/结果) | 内容仅在本地生成</p>
                    </div>
                </div>
            </div>

            <!-- Stage 3: 分析过渡动画 -->
            <div v-if="stage === 'analyzing'" class="flex-1 flex flex-col items-center justify-center bg-white/80 backdrop-blur z-40">
                <div class="relative w-32 h-32 mb-8">
                    <div class="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
                    <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
                    <i class="fa-solid fa-brain absolute inset-0 flex items-center justify-center text-4xl text-indigo-600 animate-pulse"></i>
                </div>
                <h2 class="text-2xl font-serif font-bold text-gray-800 mb-2">正在编织你的职业画像...</h2>
                <p class="text-gray-500 text-sm animate-pulse">{{ analysisStatus }}</p>
            </div>

            <!-- Stage 4: 结果展示 (简历 或 建议) -->
            <div v-if="stage === 'result'" class="flex-1 overflow-hidden relative bg-gray-100 flex">
                <!-- 左侧控制栏 -->
                <div class="w-64 bg-white border-r border-gray-200 flex flex-col p-6 shadow-lg z-10">
                    <h3 class="text-lg font-bold text-gray-800 mb-6 serif">生成完毕</h3>
                    
                    <div class="mb-6">
                        <div class="text-xs text-gray-500 mb-1 uppercase">匹配度评估</div>
                        <div class="flex items-end gap-2">
                            <span class="text-3xl font-bold" :class="matchScore >= 70 ? 'text-indigo-600' : 'text-orange-500'">{{ matchScore }}</span>
                            <span class="text-sm text-gray-400 mb-1">/ 100</span>
                        </div>
                        <div class="w-full bg-gray-200 h-1.5 rounded-full mt-2 overflow-hidden">
                            <div class="h-full rounded-full transition-all duration-1000" 
                                 :class="matchScore >= 70 ? 'bg-indigo-600' : 'bg-orange-500'"
                                 :style="{width: matchScore + '%'}"></div>
                        </div>
                    </div>

                    <div class="space-y-3">
                         <button v-if="mode === 'resume'" @click="downloadPDF" class="w-full py-2.5 px-4 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition flex items-center justify-center gap-2 shadow-lg shadow-indigo-500/30">
                            <i class="fa-solid fa-download"></i> 下载 PDF
                        </button>
                        <button @click="resetApp" class="w-full py-2.5 px-4 bg-white border border-gray-200 hover:bg-gray-50 text-gray-700 rounded-lg text-sm font-medium transition">
                            <i class="fa-solid fa-rotate-left"></i> 重新探索
                        </button>
                    </div>

                    <div class="mt-auto pt-6 border-t border-gray-100">
                        <p class="text-xs text-gray-400 leading-relaxed">
                            <i class="fa-solid fa-quote-left text-indigo-200 mr-1"></i>
                            {{ feedbackQuote }}
                        </p>
                    </div>
                </div>

                <!-- 右侧预览区 -->
                <div class="flex-1 overflow-y-auto p-8 flex justify-center bg-gray-50">
                    
                    <!-- 模式 A: 简历预览 -->
                    <div v-if="mode === 'resume'" id="resume-preview" class="resume-paper w-[210mm] p-[20mm] text-gray-800">
                        <!-- 简历头部 -->
                        <header class="border-b-2 border-gray-800 pb-6 mb-8 flex justify-between items-end">
                            <div>
                                <h1 class="text-4xl font-bold text-gray-900 mb-2 serif">{{ resumeData.name || '你的名字' }}</h1>
                                <p class="text-lg text-gray-600">{{ resumeData.targetTitle || '目标职位' }}</p>
                            </div>
                            <div class="text-right text-sm text-gray-500 space-y-1">
                                <p><i class="fa-solid fa-phone mr-2"></i>{{ resumeData.contact || '138-xxxx-xxxx' }}</p>
                                <p><i class="fa-solid fa-envelope mr-2"></i>{{ resumeData.email || 'email@example.com' }}</p>
                            </div>
                        </header>

                        <!-- 核心优势 (Profile) -->
                        <section class="mb-8">
                            <h2 class="text-lg font-bold text-indigo-800 uppercase tracking-wider mb-3 border-b border-gray-200 pb-1">
                                <i class="fa-solid fa-user-astronaut mr-2"></i>核心优势
                            </h2>
                            <p class="text-sm leading-relaxed text-gray-700">{{ resumeData.summary }}</p>
                        </section>

                        <!-- 工作/项目经历 (STAR) -->
                        <section class="mb-8">
                            <h2 class="text-lg font-bold text-indigo-800 uppercase tracking-wider mb-4 border-b border-gray-200 pb-1">
                                <i class="fa-solid fa-briefcase mr-2"></i>重点经历
                            </h2>
                            <div v-for="(exp, i) in resumeData.experiences" :key="i" class="mb-5">
                                <div class="flex justify-between items-baseline mb-1">
                                    <h3 class="font-bold text-gray-800">{{ exp.role }}</h3>
                                    <span class="text-sm text-gray-500">{{ exp.date }}</span>
                                </div>
                                <p class="text-sm font-medium text-gray-600 mb-2">{{ exp.company }}</p>
                                <ul class="list-disc list-outside ml-4 text-sm text-gray-700 space-y-1">
                                    <li v-for="(point, j) in exp.points" :key="j">{{ point }}</li>
                                </ul>
                            </div>
                        </section>

                        <!-- 技能 -->
                        <section>
                            <h2 class="text-lg font-bold text-indigo-800 uppercase tracking-wider mb-4 border-b border-gray-200 pb-1">
                                <i class="fa-solid fa-layer-group mr-2"></i>技能 & 能力
                            </h2>
                            <div class="flex flex-wrap gap-2">
                                <span v-for="(skill, k) in resumeData.skills" :key="k" class="px-3 py-1 bg-gray-100 text-gray-700 text-xs rounded font-medium">
                                    {{ skill }}
                                </span>
                            </div>
                        </section>
                    </div>

                    <!-- 模式 B: 职业推荐报告 (当匹配度低时) -->
                    <div v-else class="w-full max-w-4xl space-y-6">
                        <div class="bg-white p-8 rounded-2xl shadow-sm border-l-4 border-orange-400">
                            <h2 class="text-2xl font-bold text-gray-800 mb-2">职业探索建议</h2>
                            <p class="text-gray-600">
                                似乎你目前的目标职位与你的核心动机或过往经历匹配度尚未达到最佳状态（匹配度 {{matchScore}}%）。
                                <br>但这正是探索的开始！基于我们的深度对话，AI 职业教练为你发现了以下更适合的路径：
                            </p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div v-for="(rec, idx) in careerSuggestions" :key="idx" class="bg-white p-6 rounded-xl shadow-sm hover:shadow-md transition border border-gray-100">
                                <div class="w-12 h-12 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 text-xl mb-4">
                                    <i class="fa-solid fa-lightbulb"></i>
                                </div>
                                <h3 class="text-xl font-bold text-gray-800 mb-2">{{ rec.title }}</h3>
                                <p class="text-sm text-gray-500 mb-4">{{ rec.reason }}</p>
                                <div class="space-y-2">
                                    <div class="text-xs font-bold text-gray-400 uppercase">迁移技能</div>
                                    <div class="flex flex-wrap gap-1">
                                        <span v-for="s in rec.skills" class="px-2 py-1 bg-gray-50 text-gray-600 text-[10px] border border-gray-200 rounded">{{ s }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-100">
                            <h4 class="font-bold text-indigo-800 mb-2">下一步行动</h4>
                            <ul class="list-disc ml-5 text-sm text-indigo-700 space-y-1">
                                <li>尝试调研上述职位的一天工作内容。</li>
                                <li>针对新方向，我们可以重新开始一轮对话来挖掘具体匹配经历。</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

        </section>
    </main>

    <!-- API Key Modal -->
    <div v-if="showApiModal" class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white rounded-2xl p-6 w-full max-w-md shadow-2xl transform transition-all">
            <h3 class="text-lg font-bold text-gray-800 mb-4">设置 API Key</h3>
            <input v-model="tempKey" type="password" class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Paste your Gemini Key here">
            <div class="flex justify-end gap-2">
                <button @click="showApiModal = false" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded-lg transition">取消</button>
                <button @click="saveKey(); showApiModal = false" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">保存</button>
            </div>
        </div>
    </div>

</div>

<script>
    const { createApp, ref, reactive, computed, nextTick, onMounted } = Vue;

    createApp({
        setup() {
            // 状态定义
            const apiKey = ref(localStorage.getItem('gemini_key') || '');
            const hasServerKey = ref(false);
            const tempKey = ref('');
            const showApiModal = ref(false);
            const stage = ref('chat'); // chat, analyzing, result
            const mode = ref('resume'); // resume, suggestion
            const userInput = ref('');
            const isLoading = ref(false);
            const analysisStatus = ref('正在回顾对话内容...');
            const matchScore = ref(0);
            const feedbackQuote = ref('');
            
            const insights = ref([]); // 收集的用户关键词
            
            // To-Do List 状态
            const todoList = reactive([
                { id: 'goal', text: '明确职业方向与动机', done: false },
                { id: 'exp_1', text: '深度探索：经历挖掘 (STAR)', done: false },
                { id: 'values', text: '分析个人优势与价值观', done: false },
                { id: 'ready', text: '准备生成结构化档案', done: false }
            ]);

            // 聊天历史
            const chatHistory = ref([
                {
                    role: 'model',
                    text: "你好！我是「言出我才」的 AI 职业教练。我知道写简历有时候让人无从下笔，甚至会让人感到有些迷茫。别担心，我们不填表格，只是聊聊天。\n\n首先，我想听听你现在的情况。**你是正在寻找职业转型的机会，还是刚步入职场，亦或是对当下的工作感到有些焦虑？**"
                }
            ]);

            // 内部系统 Prompt - 定义 AI 人格与逻辑
            const systemPrompt = `
                You are an expert AI Career Coach named "言出我才" (Speak Your Talent). 
                Your goal is NOT just to write a resume, but to help the user explore their self-identity, motivations, and achievements through deep dialogue (Motivational Interviewing & STAR method).
                
                **Workflow:**
                1. **Phase 1 (Goal):** Clarify user's current state (student/career changer/lost), motivation, and anxiety. Be empathetic.
                2. **Phase 2 (Deep Dive):** Use STAR method (Situation, Task, Action, Result) to dig into specific experiences. Ask "What did you do exactly?" and "What was the impact?". Don't accept vague answers. Guide them gently.
                3. **Phase 3 (Wrap up):** When you have enough info (approx 4-6 turns), tell the user you are ready to generate their profile.
                
                **CRITICAL OUTPUT RULE:**
                At the very end of EVERY response, you MUST append a HIDDEN JSON block enclosed in '///' to update the UI state. The user will not see this, but the system will parse it.
                Format: /// {"progress_stage": "goal" | "exp_1" | "values" | "ready", "insights": ["keyword1", "keyword2"]} ///
                
                - "progress_stage": Update the checklist based on conversation depth.
                - "insights": Extract 1-2 short keywords about the user's skills or values (e.g., "Leadership", "Resilient").
                
                Keep the tone professional, warm, encouraging, and insightful (psychological approach). Language: Chinese (Simplified).
            `;

            // 保存 Key
            const saveKey = () => {
                if(tempKey.value.trim()){
                    apiKey.value = tempKey.value.trim();
                    localStorage.setItem('gemini_key', apiKey.value);
                    showApiModal.value = false;
                }
            };

            const MODEL = 'gemini-flash-lite-latest';
            const MAX_RETRIES = 5;
            const BASE_DELAY = 1500;

            const requestGemini = async (contents, onRetry) => {
                let attempt = 0;
                while (true) {
                    try {
                        const response = await fetch(`http://localhost:8765/api/generate`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ model: MODEL, contents })
                        });
                        if (response.ok) {
                            const data = await response.json();
                            return data;
                        }
                        const errText = await response.text();
                        attempt++;
                        if ((response.status !== 503 && response.status !== 429) || attempt >= MAX_RETRIES) {
                            throw new Error(`HTTP ${response.status} ${response.statusText}: ${errText}`);
                        }
                        const wait = BASE_DELAY * Math.pow(2, attempt) + Math.floor(Math.random() * 400);
                        if (typeof onRetry === 'function') onRetry(attempt, wait);
                        await new Promise(r => setTimeout(r, wait));
                    } catch (e) {
                        attempt++;
                        if (attempt >= MAX_RETRIES) throw e;
                        const wait = BASE_DELAY * Math.pow(2, attempt) + Math.floor(Math.random() * 400);
                        if (typeof onRetry === 'function') onRetry(attempt, wait);
                        await new Promise(r => setTimeout(r, wait));
                    }
                }
            };

            // 发送消息
            const sendMessage = async () => {
                if (!userInput.value.trim() || isLoading.value) return;
                
                
                const text = userInput.value;
                chatHistory.value.push({ role: 'user', text: text });
                userInput.value = '';
                isLoading.value = true;

                // 滚动到底部
                await nextTick();
                const container = document.getElementById('chat-container');
                if(container) container.scrollTop = container.scrollHeight;

                try {
                    // 1. 构造请求 API
                    // 注意：这里为了 Demo 简单，将历史记录都带上。实际中可能需要剪枝。
                    const promptHistory = chatHistory.value.map(m => ({
                        role: m.role === 'model' ? 'model' : 'user',
                        parts: [{ text: m.text }]
                    }));

                    // 插入 System Prompt 到最开始 (Gemini API 通过 systemInstruction 或者第一个 user message 模拟)
                    // 这里的处理方式是把 System Prompt 拼接到第一个 User 消息前，或者作为 separate context。
                    // 简单的做法：
                    const fullContents = [
                        { role: 'user', parts: [{ text: systemPrompt + "\n\n[Conversation Start]" }] },
                        ...promptHistory
                    ];

                    const data = await requestGemini(fullContents, (attempt, wait) => {
                        chatHistory.value.push({ role: 'model', text: `(系统提示: 模型繁忙，正在重试(${attempt}/${MAX_RETRIES})，预计等待 ${wait}ms)` });
                    });
                    
                    if (data.error) {
                        throw new Error(data.error.message);
                    }

                    const rawText = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    if (!rawText) {
                        throw new Error('API 返回为空或格式异常');
                    }
                    
                    // 2. 解析隐藏的 JSON 指令
                    let cleanText = rawText;
                    const jsonMatch = rawText.match(/\/\/\/([\s\S]*?)\/\/\//);
                    
                    if (jsonMatch) {
                        cleanText = rawText.replace(jsonMatch[0], '').trim();
                        try {
                            const meta = JSON.parse(jsonMatch[1]);
                            updateState(meta);
                        } catch (e) { console.error("JSON Parse error", e); }
                    }

                    chatHistory.value.push({ role: 'model', text: cleanText });

                } catch (err) {
                    chatHistory.value.push({ role: 'model', text: `(系统错误: ${err.message} - 可能是 API Key、CORS/Referer 限制或网络问题)` });
                } finally {
                    isLoading.value = false;
                    await nextTick();
                    const container = document.getElementById('chat-container');
                    if(container) container.scrollTop = container.scrollHeight;
                }
            };

            // 更新状态机
            const updateState = (meta) => {
                // 更新 Insights
                if(meta.insights) {
                    meta.insights.forEach(i => {
                        if(!insights.value.includes(i)) insights.value.push(i);
                    });
                }

                // 更新 ToDo List
                if(meta.progress_stage) {
                    const stageMap = { 'goal': 0, 'exp_1': 1, 'values': 2, 'ready': 3 };
                    const currentIdx = stageMap[meta.progress_stage];
                    
                    // 将当前及之前的都标记为 done
                    todoList.forEach((item, idx) => {
                        if (idx <= currentIdx) item.done = true;
                    });

                    // 如果到了 ready 阶段，并且用户发了新消息，我们可以触发生成
                    if (meta.progress_stage === 'ready' && !document.getElementById('generate-btn')) {
                        // 添加一个特殊的系统消息按钮或者自动触发
                         setTimeout(() => {
                             if(confirm("看来我们已经收集了足够的信息。要现在为你生成分析报告和简历吗？")) {
                                 generateResult();
                             }
                         }, 1000);
                    }
                }
            };

            // 最终生成阶段
            const resumeData = reactive({ name: '', summary: '', experiences: [], skills: [] });
            const careerSuggestions = ref([]);

            const generateResult = async () => {
                stage.value = 'analyzing';
                
                // 构造 Analysis Prompt
                const analysisPrompt = `
                    Based on the following conversation history, analyze the user's profile.
                    
                    You need to determine two things:
                    1. Match Score (0-100): How well defined is their career goal and experience?
                    2. Output Content:
                       - If Score > 60: Generate a structured Resume JSON.
                       - If Score <= 60: Generate Career Suggestions JSON (Alternative paths).

                    Conversation History:
                    ${chatHistory.value.map(m => `${m.role}: ${m.text}`).join('\n')}
                    
                    Output strictly VALID JSON format:
                    {
                        "matchScore": 75,
                        "mode": "resume", // or "suggestion"
                        "feedbackQuote": "One sentence strictly summarizing why they are good.",
                        "resume": {
                            "name": "Predicted Name or [Candidate]",
                            "targetTitle": "Inferred Target Job",
                            "contact": "Phone/Email placeholder",
                            "summary": "Professional summary emphasizing values found in chat.",
                            "skills": ["skill1", "skill2"],
                            "experiences": [
                                { "role": "Role Name", "company": "Company", "date": "Date", "points": ["Action-oriented bullet point 1 (STAR)", "Bullet point 2"] }
                            ]
                        },
                        "suggestions": [
                            { "title": "Job Title", "reason": "Why this fits their psychology/skills", "skills": ["Transferable Skill 1"] }
                        ]
                    }
                `;

                try {
                    analysisStatus.value = "正在应用 STAR 原则提取关键行为...";
                    await new Promise(r => setTimeout(r, 1500));
                    analysisStatus.value = "正在构建胜任力模型...";

                    const data = await requestGemini([{ parts: [{ text: analysisPrompt }] }], (attempt) => {
                        analysisStatus.value = `模型繁忙，正在重试(${attempt}/${MAX_RETRIES})...`;
                    });
                    let resultText = data?.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    if (!resultText) {
                        throw new Error('API 返回为空或格式异常');
                    }
                    
                    // 清理 JSON markdown 标记
                    resultText = resultText.replace(/```json/g, '').replace(/```/g, '').trim();
                    
                    const resultJson = JSON.parse(resultText);

                    // 填充数据
                    matchScore.value = resultJson.matchScore;
                    mode.value = resultJson.mode;
                    feedbackQuote.value = resultJson.feedbackQuote;
                    
                    if (resultJson.mode === 'resume') {
                        Object.assign(resumeData, resultJson.resume);
                    } else {
                        careerSuggestions.value = resultJson.suggestions;
                    }

                    stage.value = 'result';

                } catch (e) {
                    alert("生成分析失败，请重试。" + e.message);
                    stage.value = 'chat';
                }
            };

            const renderMarkdown = (text) => {
                return marked.parse(text);
            };

            const downloadPDF = () => {
                const element = document.getElementById('resume-preview');
                const opt = {
                    margin: 0,
                    filename: '我的简历_言出我才.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2 },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                html2pdf().set(opt).from(element).save();
            };

            const resetApp = () => {
                if(confirm("确定要清除所有对话重新开始吗？")) {
                    location.reload();
                }
            };

            onMounted(async () => {
                const qs = new URLSearchParams(location.search);
                const hs = new URLSearchParams(location.hash.replace(/^#/, ''));
                const injected = qs.get('key') || hs.get('key') || (window.__GEMINI_KEY__ || '');
                if (injected) {
                    apiKey.value = injected;
                    localStorage.setItem('gemini_key', injected);
                }
                if (location.protocol === 'file:' && !apiKey.value) {
                    chatHistory.value.push({ role: 'model', text: '(系统提示: 请使用 http://localhost 通过本地服务器打开此页面，或在 Google Cloud Console 将 API Key 的应用限制设置为“无”。直接以 file:// 打开可能因 Referer 限制导致请求失败。)' });
                }
                try {
                    const r = await fetch('http://localhost:8765/api/health');
                    if (r.ok) {
                        const j = await r.json();
                        hasServerKey.value = !!j.has_key;
                    }
                } catch {}
            });

            return {
                apiKey, tempKey, showApiModal, saveKey,
                stage, mode, userInput, chatHistory, sendMessage, isLoading,
                todoList, insights, hasServerKey,
                resumeData, careerSuggestions, matchScore, feedbackQuote,
                renderMarkdown, downloadPDF, resetApp, analysisStatus
            };
        }
    }).mount('#app');
</script>
</body>
</html>
